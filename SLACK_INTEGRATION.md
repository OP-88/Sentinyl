# Slack Integration Guide

## Overview

Sentinyl now supports **Slack webhooks** with rich **Block Kit** formatting for real-time security alerts. This provides a more interactive and visually appealing notification system compared to traditional text-based alerts.

## Features

### üé® Rich Block Kit Formatting

- **Header blocks** with emoji shields (üõ°Ô∏è)
- **Structured sections** with fields for severity, target domain, and threat details
- **Color-coded severity** indicators
- **Action buttons** for CRITICAL alerts (link to dashboard and repositories)
- **Dividers** for visual separation
- **Context footers** with timestamps

### ‚ö° Real-Time Alerting

- **Immediate notifications**: Alerts sent as soon as threats are detected
- **Per-threat alerts**: Each typosquat or leak triggers an individual alert
- **Scan summaries**: Final summary sent after scan completion

### üìä Alert Types

#### Typosquatting Alerts
- Malicious domain detected
- IP address information
- Nameserver details
- CRITICAL severity with red action button

#### GitHub Leak Alerts
- Repository name and URL
- File path containing leak
- Leak type (password, API key, secret, etc.)
- Direct link to repository for investigation

## Setup Instructions

### 1. Create Slack Incoming Webhook

1. Go to your Slack workspace settings
2. Navigate to **Apps** ‚Üí **Manage Apps**
3. Search for "Incoming Webhooks" and add to Slack
4. Click **Add New Webhook to Workspace**
5. Select the channel where you want to receive alerts
6. Copy the webhook URL (format: `https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXX`)

**Detailed guide**: https://api.slack.com/messaging/webhooks

### 2. Configure Sentinyl

Add the webhook URL to your `.env` file:

```bash
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/YOUR/WEBHOOK/URL
```

### 3. Test the Integration

Run a test scan:

```bash
curl -X POST http://localhost:8000/scan \
  -H "Content-Type: application/json" \
  -d '{"domain": "example.com", "scan_type": "typosquat"}'
```

You should receive Slack notifications as threats are detected.

## Alert Format Examples

### Typosquatting Alert

```
üõ°Ô∏è Sentinyl Security Alert

Severity: üî¥ CRITICAL
Target Domain: example.com
Threat Type: Typosquat
Malicious Domain: examp1e.com
IP Address: 192.0.2.1

Nameservers:
‚Ä¢ ns1.malicious.com
‚Ä¢ ns2.malicious.com

[üîç View Dashboard]  (red button linking to http://localhost:3000)

üïê Alert generated by Sentinyl DRP Platform
```

### GitHub Leak Alert

```
üõ°Ô∏è Sentinyl Security Alert

Severity: üö® HIGH
Target Domain: yourcompany.com
Threat Type: Leak
Repository: username/repo-name
Leak Type: api_key

File Path: config/settings.json

[üîç View Dashboard]  [üìÇ View Repository]

üïê Alert generated by Sentinyl DRP Platform
```

### Scan Summary

```
‚úÖ Scan Complete

Domain: example.com
Scan Type: Typosquat
Total Threats: 5
Critical: 3
```

## Code Implementation

### SlackNotifier Class

Located in: `workers/slack_utils.py`

**Key Methods:**

```python
# Initialize notifier
notifier = SlackNotifier(webhook_url="https://hooks.slack.com/...")

# Send threat alert
notifier.send_alert(
    domain="example.com",
    threat_type="typosquat",  # or "leak"
    severity="CRITICAL",       # LOW, MEDIUM, HIGH, CRITICAL
    details={
        "malicious_domain": "examp1e.com",
        "ip_address": "192.0.2.1",
        "nameservers": ["ns1.example.com"]
    }
)

# Send scan summary
notifier.send_summary(
    domain="example.com",
    scan_type="typosquat",
    total_threats=5,
    critical_threats=3
)
```

### Integration in Workers

Both `typosquat_worker.py` and `leak_worker.py` automatically:
1. Initialize `SlackNotifier` on job start
2. Send immediate alerts when CRITICAL/HIGH threats are detected
3. Send a summary when the scan completes

## Block Kit JSON Structure

Example Block Kit payload sent to Slack:

```json
{
  "blocks": [
    {
      "type": "header",
      "text": {
        "type": "plain_text",
        "text": "üõ°Ô∏è Sentinyl Security Alert",
        "emoji": true
      }
    },
    {
      "type": "section",
      "fields": [
        {
          "type": "mrkdwn",
          "text": "*Severity:*\nüî¥ CRITICAL"
        },
        {
          "type": "mrkdwn",
          "text": "*Target Domain:*\n`example.com`"
        }
      ]
    },
    {
      "type": "divider"
    },
    {
      "type": "actions",
      "elements": [
        {
          "type": "button",
          "text": {
            "type": "plain_text",
            "text": "üîç View Dashboard"
          },
          "style": "danger",
          "url": "http://localhost:3000"
        }
      ]
    }
  ]
}
```

## Severity Levels

| Level | Emoji | Color | Use Case |
|-------|-------|-------|----------|
| LOW | ‚ÑπÔ∏è | Green (#36a64f) | Minor findings, low confidence |
| MEDIUM | ‚ö†Ô∏è | Orange (#ff9900) | Potential issues requiring review |
| HIGH | üö® | Red-Orange (#ff6600) | Confirmed threats, action needed |
| CRITICAL | üî¥ | Red (#cc0000) | Active threats, immediate action required |

## Comparison: Slack vs Telegram

| Feature | Slack | Telegram |
|---------|-------|----------|
| Rich Formatting | ‚úÖ Block Kit JSON | ‚ùå Markdown only |
| Interactive Buttons | ‚úÖ Yes | ‚ö†Ô∏è Limited |
| Color-coded Severity | ‚úÖ Yes | ‚ùå No |
| Enterprise Integration | ‚úÖ Native | ‚ö†Ô∏è External |
| Setup Complexity | ‚≠ê‚≠ê Medium | ‚≠ê Easy |
| Visual Appeal | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excellent | ‚≠ê‚≠ê‚≠ê Good |

## Troubleshooting

### Alerts Not Sending

1. **Check webhook URL**:
   ```bash
   echo $SLACK_WEBHOOK_URL
   ```

2. **Test webhook manually**:
   ```bash
   curl -X POST $SLACK_WEBHOOK_URL \
     -H 'Content-Type: application/json' \
     -d '{"text": "Test from Sentinyl"}'
   ```

3. **Check worker logs**:
   ```bash
   docker-compose logs -f worker | grep -i slack
   ```

### Invalid Webhook URL

Error: `Failed to send Slack alert: 404 Client Error`

**Solution**: Verify webhook URL is correct and webhook is still active in Slack settings.

### Rate Limiting

Slack webhooks have a rate limit of approximately 1 message per second.

**Solution**: Sentinyl automatically handles this by sending one alert per detected threat.

## Best Practices

1. **Use dedicated channel**: Create a `#security-alerts` channel for Sentinyl notifications
2. **Set up alerting rules**: Configure Slack notification rules for @mentions on CRITICAL alerts
3. **Monitor webhook health**: Regularly test the webhook to ensure it's active
4. **Rotate webhooks**: Periodically rotate webhook URLs for security
5. **Configure retention**: Set appropriate message retention in Slack for compliance

## Advanced Customization

### Custom Dashboard URL

Edit `workers/slack_utils.py` and modify the button URL:

```python
{
    "type": "button",
    "text": {"type": "plain_text", "text": "üîç View Dashboard"},
    "style": "danger",
    "url": "https://your-dashboard.example.com"  # Custom URL
}
```

### Additional Fields

Add custom fields to alerts by modifying `_build_blocks()` method:

```python
fields.append({
    "type": "mrkdwn",
    "text": f"*Custom Field:*\n{custom_value}"
})
```

### Alternative Notification Channels

You can create multiple webhooks for different channels and route alerts based on severity:

```python
if severity == "CRITICAL":
    webhook_url = os.getenv("SLACK_CRITICAL_WEBHOOK")
else:
    webhook_url = os.getenv("SLACK_GENERAL_WEBHOOK")
```

## Resources

- **Slack Block Kit Builder**: https://app.slack.com/block-kit-builder
- **Incoming Webhooks Guide**: https://api.slack.com/messaging/webhooks
- **Block Kit Documentation**: https://api.slack.com/block-kit
- **Webhook Rate Limits**: https://api.slack.com/docs/rate-limits

## Support

For issues or questions about Slack integration:
1. Check the troubleshooting section above
2. Review worker logs: `docker-compose logs worker`
3. Test webhook URL manually
4. Open an issue on GitHub with logs and configuration (redact sensitive data)
